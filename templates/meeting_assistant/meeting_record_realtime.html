{% extends "base.html" %}

{% block title %}å®æ—¶å½•éŸ³ - ç†µå‡X-AI{% endblock %}

{% block extra_css %}
<style>
.meeting-recorder-container {
    display: flex;
    height: calc(100vh - 70px);
    overflow: hidden;
}

.recorder-left-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #dee2e6;
    background: #f8f9fa;
}

.recorder-right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
}

.control-bar {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.control-bar h3 {
    margin: 0 0 15px 0;
    font-size: 24px;
}

.form-control {
    margin-bottom: 10px;
    border-radius: 8px;
    border: none;
    padding: 10px 15px;
}

.timer-display {
    font-size: 48px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    text-align: center;
    margin: 15px 0;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 20px;
}

.btn-group .btn {
    margin: 0 5px;
    padding: 10px 25px;
    font-size: 16px;
    border-radius: 25px;
    border: 2px solid white;
    background: transparent;
    color: white;
    transition: all 0.3s;
}

.btn-group .btn:hover:not(:disabled) {
    background: white;
    color: #667eea;
}

.btn-group .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-start {
    background: #28a745 !important;
    border-color: #28a745 !important;
}

.btn-stop {
    background: #dc3545 !important;
    border-color: #dc3545 !important;
}

.transcript-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: white;
}

.transcript-item {
    padding: 12px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    border-radius: 5px;
    animation: fadeIn 0.3s ease-in;
}

.transcript-item.new {
    background: #e7f3ff;
    border-left-color: #28a745;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.speaker-label {
    font-weight: bold;
    color: #667eea;
    margin-bottom: 5px;
}

.transcript-time {
    font-size: 12px;
    color: #6c757d;
    margin-left: 10px;
}

.notes-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.notes-section {
    margin-bottom: 20px;
}

.notes-section h4 {
    color: #667eea;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #667eea;
}

.note-item {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.note-item textarea {
    width: 100%;
    border: none;
    background: transparent;
    resize: vertical;
    min-height: 60px;
    font-size: 14px;
}

.note-item textarea:focus {
    outline: none;
}

.todo-item {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    padding: 10px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.todo-item input[type="checkbox"] {
    margin-right: 10px;
    transform: scale(1.2);
}

.todo-item input[type="text"] {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 14px;
}

.todo-item input[type="text"]:focus {
    outline: none;
}

.add-btn {
    width: 100%;
    padding: 10px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
}

.add-btn:hover {
    background: #5568d3;
}

.template-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.template-modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
}

.template-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.template-card {
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.template-card:hover {
    border-color: #667eea;
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.template-card.selected {
    border-color: #667eea;
    background: #f0f4ff;
}

.template-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.template-title {
    font-weight: bold;
    margin-bottom: 5px;
}

.template-desc {
    font-size: 12px;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="meeting-recorder-container">
    <!-- å·¦ä¾§é¢æ¿ï¼šå½•éŸ³æ§åˆ¶å’Œè½¬å†™ -->
    <div class="recorder-left-panel">
        <div class="control-bar">
            <h3>ğŸ™ï¸ å®æ—¶å½•éŸ³</h3>
            <select id="repository_id" class="form-control">
                <option value="">é€‰æ‹©ä»“åº“...</option>
                {% for repo in repositories %}
                <option value="{{ repo.id }}">{{ repo.name }}</option>
                {% endfor %}
            </select>
            <input type="text" id="meeting_title" class="form-control" placeholder="ä¼šè®®æ ‡é¢˜" value="ä¼šè®®å½•éŸ³">
            <input type="datetime-local" id="meeting_date" class="form-control">
            <input type="text" id="participants" class="form-control" placeholder="å‚ä¼šäººå‘˜ï¼ˆé€—å·åˆ†éš”ï¼‰">
            
            <div class="timer-display" id="timer">00:00:00</div>
            
            <div class="btn-group">
                <button id="startRecordBtn" class="btn btn-start" onclick="startRecording()">
                    <i class="bi bi-mic"></i> å¼€å§‹å½•éŸ³
                </button>
                <button id="stopRecordBtn" class="btn btn-stop" onclick="stopRecording()" disabled>
                    <i class="bi bi-stop"></i> åœæ­¢å½•éŸ³
                </button>
                <button id="generateWithTemplateBtn" class="btn btn-info" onclick="showTemplateModal()">
                    <i class="bi bi-file-earmark-text"></i> é€‰æ‹©æ¨¡æ¿
                </button>
            </div>
            
            <div id="recordingStatus" class="text-center mt-3">
                <span class="badge bg-secondary">æœªå¼€å§‹</span>
            </div>
        </div>
        
        <div class="transcript-container" id="transcriptContainer">
            <div class="text-muted text-center py-5">
                <i class="bi bi-mic-mute" style="font-size: 48px;"></i>
                <p class="mt-3">å¼€å§‹å½•éŸ³åï¼Œè½¬å†™å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§é¢æ¿ï¼šç¬”è®°å’Œå¾…åŠ -->
    <div class="recorder-right-panel">
        <div class="notes-container">
            <div class="notes-section">
                <h4>ğŸ“ ä¼šè®®ç¬”è®°</h4>
                <div id="notesList">
                    <div class="note-item">
                        <textarea placeholder="åœ¨è¿™é‡Œè®°å½•ç¬”è®°..."></textarea>
                    </div>
                </div>
                <button class="add-btn" onclick="addNote()">+ æ·»åŠ ç¬”è®°</button>
            </div>
            
            <div class="notes-section">
                <h4>âœ… å¾…åŠäº‹é¡¹</h4>
                <div id="todoList">
                    <div class="todo-item">
                        <input type="checkbox">
                        <input type="text" placeholder="æ·»åŠ å¾…åŠäº‹é¡¹...">
                    </div>
                </div>
                <button class="add-btn" onclick="addTodo()">+ æ·»åŠ å¾…åŠ</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡† -->
<div class="template-modal" id="templateModal">
    <div class="template-content">
        <h3 class="mb-4">ğŸ“„ é€‰æ‹©æ–‡æ¡£æ¨¡æ¿</h3>
        <p class="text-muted">é€‰æ‹©æ‚¨éœ€è¦çš„æ–‡æ¡£æ ¼å¼ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆ</p>
        
        <div class="template-grid">
            <div class="template-card" onclick="selectTemplate('å›¾æ–‡çºªè¦')">
                <div class="template-icon">ğŸ“Š</div>
                <div class="template-title">å›¾æ–‡çºªè¦</div>
                <div class="template-desc">åŒ…å«å›¾è¡¨å’Œè¦ç‚¹çš„å¯è§†åŒ–çºªè¦</div>
            </div>
            
            <div class="template-card" onclick="selectTemplate('ä¼šè®®çºªè¦')">
                <div class="template-icon">ğŸ“‹</div>
                <div class="template-title">ä¼šè®®çºªè¦</div>
                <div class="template-desc">æ ‡å‡†çš„ä¼šè®®è®°å½•æ ¼å¼</div>
            </div>
            
            <div class="template-card" onclick="selectTemplate('é¢è¯•æŠ¥å‘Š')">
                <div class="template-icon">ğŸ‘¤</div>
                <div class="template-title">é¢è¯•æŠ¥å‘Š</div>
                <div class="template-desc">åŒ…å«é¢è¯•è¯„ä¼°å’Œå»ºè®®</div>
            </div>
            
            <div class="template-card" onclick="selectTemplate('å­¦ä¹ ç¬”è®°')">
                <div class="template-icon">ğŸ“š</div>
                <div class="template-title">å­¦ä¹ ç¬”è®°</div>
                <div class="template-desc">çŸ¥è¯†ç‚¹çš„ç»“æ„åŒ–æ€»ç»“</div>
            </div>
            
            <div class="template-card" onclick="selectTemplate('æ—¥å¸¸è®°å½•')">
                <div class="template-icon">ğŸ“</div>
                <div class="template-title">æ—¥å¸¸è®°å½•</div>
                <div class="template-desc">ç®€æ´çš„æ—¥å¸¸å¤‡å¿˜å½•</div>
            </div>
            
            <div class="template-card" onclick="selectTemplate('é¡¹ç›®æ€»ç»“')">
                <div class="template-icon">ğŸ“ˆ</div>
                <div class="template-title">é¡¹ç›®æ€»ç»“</div>
                <div class="template-desc">é¡¹ç›®è¿›åº¦å’Œæˆæœæ€»ç»“</div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-secondary" onclick="closeTemplateModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script src="/static/meeting_assistant/js/recorder.js"></script>
<script>
let recorder = null;
let transcriptBuffer = [];
let recordingStartTime = null;
let timerInterval = null;

// åˆå§‹åŒ–å½•éŸ³å™¨
async function initRecorder() {
    recorder = new MeetingRecorder({
        apiBaseUrl: '/meeting-assistant/api/',
        onStart: () => {
            document.getElementById('startRecordBtn').disabled = true;
            document.getElementById('stopRecordBtn').disabled = false;
            document.getElementById('recordingStatus').innerHTML = '<span class="badge bg-danger">å½•éŸ³ä¸­</span>';
            recordingStartTime = Date.now();
            startTimer();
            clearTranscript();
        },
        onStop: async (audioBlob) => {
            stopTimer();
            document.getElementById('startRecordBtn').disabled = false;
            document.getElementById('stopRecordBtn').disabled = true;
            document.getElementById('recordingStatus').innerHTML = '<span class="badge bg-success">å·²å®Œæˆ</span>';
            
            // æ˜¾ç¤ºæ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
            showTemplateModal();
            
            // ä¿å­˜audioBlobä¾›åç»­ä½¿ç”¨
            window.currentAudioBlob = audioBlob;
        },
        onError: (error) => {
            alert('é”™è¯¯: ' + error);
            document.getElementById('recordingStatus').innerHTML = '<span class="badge bg-danger">é”™è¯¯</span>';
        }
    });
    
    const initialized = await recorder.init();
    if (!initialized) {
        alert('æ— æ³•åˆå§‹åŒ–å½•éŸ³å™¨ï¼Œè¯·ç¡®ä¿å·²æˆæƒéº¦å…‹é£è®¿é—®æƒé™');
    }
}

// å¼€å§‹å½•éŸ³
async function startRecording() {
    const repositoryId = document.getElementById('repository_id').value;
    const meetingTitle = document.getElementById('meeting_title').value;
    
    if (!repositoryId) {
        alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
        return;
    }
    
    if (!meetingTitle) {
        alert('è¯·è¾“å…¥ä¼šè®®æ ‡é¢˜');
        return;
    }
    
    // è®¾ç½®å½•éŸ³å™¨çš„repositoryId
    recorder.repositoryId = repositoryId;
    
    try {
        await recorder.startRecording();
    } catch (error) {
        alert('å¯åŠ¨å½•éŸ³å¤±è´¥: ' + error.message);
    }
}

// åœæ­¢å½•éŸ³
function stopRecording() {
    try {
        recorder.stopRecording();
    } catch (error) {
        alert('åœæ­¢å½•éŸ³å¤±è´¥: ' + error.message);
    }
}

// è®¡æ—¶å™¨
function startTimer() {
    timerInterval = setInterval(updateTimer, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateTimer() {
    if (!recordingStartTime) return;
    
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;
    
    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timerElement = document.getElementById('timer');
    if (timerElement) {
        timerElement.textContent = timeString;
    }
}

// æ·»åŠ è½¬å†™å†…å®¹
function addTranscript(data) {
    transcriptBuffer.push(data);
    
    const container = document.getElementById('transcriptContainer');
    
    // ç§»é™¤ç©ºçŠ¶æ€æç¤º
    if (container.querySelector('.text-muted')) {
        container.innerHTML = '';
    }
    
    // åˆ›å»ºè½¬å†™é¡¹
    const item = document.createElement('div');
    item.className = 'transcript-item new';
    item.innerHTML = `
        <div class="speaker-label">${data.speaker || 'è¯´è¯äºº'}</div>
        <div>${data.text}</div>
        <div class="transcript-time">${data.time || ''}</div>
    `;
    
    container.appendChild(item);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    container.scrollTop = container.scrollHeight;
    
    // ç§»é™¤newç±»
    setTimeout(() => {
        item.classList.remove('new');
    }, 500);
}

// æ¸…ç©ºè½¬å†™
function clearTranscript() {
    transcriptBuffer = [];
    const container = document.getElementById('transcriptContainer');
    container.innerHTML = `
        <div class="text-muted text-center py-5">
            <i class="bi bi-mic-mute" style="font-size: 48px;"></i>
            <p class="mt-3">å¼€å§‹å½•éŸ³åï¼Œè½¬å†™å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
        </div>
    `;
}

// æ·»åŠ ç¬”è®°
function addNote() {
    const notesList = document.getElementById('notesList');
    const noteItem = document.createElement('div');
    noteItem.className = 'note-item';
    noteItem.innerHTML = '<textarea placeholder="åœ¨è¿™é‡Œè®°å½•ç¬”è®°..."></textarea>';
    notesList.appendChild(noteItem);
}

// æ·»åŠ å¾…åŠ
function addTodo() {
    const todoList = document.getElementById('todoList');
    const todoItem = document.createElement('div');
    todoItem.className = 'todo-item';
    todoItem.innerHTML = `
        <input type="checkbox">
        <input type="text" placeholder="æ·»åŠ å¾…åŠäº‹é¡¹...">
    `;
    todoList.appendChild(todoItem);
}

// æ˜¾ç¤ºæ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
function showTemplateModal() {
    document.getElementById('templateModal').classList.add('show');
}

// å…³é—­æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
function closeTemplateModal() {
    document.getElementById('templateModal').classList.remove('show');
}

// é€‰æ‹©æ¨¡æ¿å¹¶ç”Ÿæˆæ–‡æ¡£
async function selectTemplate(templateType) {
    closeTemplateModal();
    
    if (!window.currentAudioBlob) {
        alert('æ²¡æœ‰å½•éŸ³æ–‡ä»¶');
        return;
    }
    
    const repositoryId = document.getElementById('repository_id').value;
    const meetingTitle = document.getElementById('meeting_title').value;
    
    // æ”¶é›†ç¬”è®°å’Œå¾…åŠ
    const notes = [];
    document.querySelectorAll('#notesList textarea').forEach(textarea => {
        if (textarea.value.trim()) {
            notes.push(textarea.value.trim());
        }
    });
    
    const todos = [];
    document.querySelectorAll('#todoList .todo-item').forEach(todo => {
        const text = todo.querySelector('input[type="text"]').value;
        if (text.trim()) {
            todos.push(text.trim());
        }
    });
    
    try {
        // ä¸Šä¼ å½•éŸ³å¹¶ä¼ é€’æ¨¡æ¿ç±»å‹
        recorder.repositoryId = repositoryId;
        const result = await recorder.uploadRecordingWithTemplate(
            window.currentAudioBlob,
            meetingTitle,
            templateType,
            notes,
            todos
        );
        
        if (result.recording_id) {
            alert(`å½•éŸ³ä¸Šä¼ æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆ${templateType}...`);
            
            // è·³è½¬åˆ°è¯¦æƒ…é¡µ
            setTimeout(() => {
                window.location.href = `/meeting-assistant/detail/${result.recording_id}/`;
            }, 2000);
        }
    } catch (error) {
        alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
    }
}

// æ‰©å±•recorder.jsçš„uploadRecordingæ–¹æ³•
MeetingRecorder.prototype.uploadRecordingWithTemplate = async function(audioBlob, title, templateType, notes, todos) {
    if (!audioBlob) {
        throw new Error('æ²¡æœ‰å½•éŸ³æ–‡ä»¶');
    }
    
    if (!this.repositoryId) {
        throw new Error('æœªé€‰æ‹©ä»“åº“');
    }
    
    const formData = new FormData();
    formData.append('repository_id', this.repositoryId);
    formData.append('audio_file', audioBlob, `recording_${Date.now()}.webm`);
    formData.append('meeting_title', title);
    formData.append('template_type', templateType);
    formData.append('notes', JSON.stringify(notes));
    formData.append('todos', JSON.stringify(todos));
    
    try {
        const csrfToken = this.getCsrfToken();
        
        const response = await fetch(this.apiBaseUrl + 'recordings/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            credentials: 'same-origin',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || errorData.detail || 'ä¸Šä¼ å¤±è´¥');
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('ä¸Šä¼ å½•éŸ³å¤±è´¥:', error);
        throw error;
    }
};

// æ‰©å±•recorder.jsçš„uploadRecordingæ–¹æ³•
MeetingRecorder.prototype.uploadRecordingWithTemplate = async function(audioBlob, title, templateType, notes, todos) {
    if (!audioBlob) {
        throw new Error('æ²¡æœ‰å½•éŸ³æ–‡ä»¶');
    }
    
    if (!this.repositoryId) {
        throw new Error('æœªé€‰æ‹©ä»“åº“');
    }
    
    const formData = new FormData();
    formData.append('repository_id', this.repositoryId);
    formData.append('audio_file', audioBlob, `recording_${Date.now()}.webm`);
    formData.append('meeting_title', title);
    formData.append('template_type', templateType);
    formData.append('notes', JSON.stringify(notes));
    formData.append('todos', JSON.stringify(todos));
    
    try {
        const csrfToken = this.getCsrfToken();
        
        const response = await fetch(this.apiBaseUrl + 'recordings/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            credentials: 'same-origin',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || errorData.detail || 'ä¸Šä¼ å¤±è´¥');
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('ä¸Šä¼ å½•éŸ³å¤±è´¥:', error);
        throw error;
    }
};

// è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´
document.getElementById('meeting_date').value = new Date().toISOString().slice(0, 16);

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å½•éŸ³å™¨
document.addEventListener('DOMContentLoaded', initRecorder);
</script>
{% endblock %}