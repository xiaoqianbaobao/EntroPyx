{% extends 'base.html' %}

{% block title %}AIæ™ºèƒ½è¯„å®¡ - ç†µå‡X-AI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-robot"></i> AIæ™ºèƒ½è¯„å®¡</h2>
    <button class="btn btn-primary" onclick="createNewSession()">
        <i class="bi bi-plus-circle"></i> æ–°å»ºä¼šè¯
    </button>
</div>

<div class="row">
    <!-- å·¦ä¾§ï¼šä¼šè¯åˆ—è¡¨ -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ä¼šè¯åˆ—è¡¨</h6>
            </div>
            <div class="card-body p-0">
                <div id="session-list" style="max-height: 600px; overflow-y: auto;">
                    <!-- ä¼šè¯åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šå¯¹è¯åŒºåŸŸ -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" id="current-session-title">è¯·é€‰æ‹©æˆ–åˆ›å»ºä¼šè¯</h6>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
                        <div class="form-check form-switch me-3" title="åˆ‡æ¢å¯¹è¯æ¨¡å¼">
                            <input class="form-check-input" type="checkbox" id="mode-switch" onchange="toggleMode()">
                            <label class="form-check-label" for="mode-switch" id="mode-label">Chatæ¨¡å¼</label>
                        </div>
                        
                        <!-- Agentæ¨¡å¼ä¸‹çš„èƒ½åŠ›é€‰æ‹© -->
                        <select class="form-select form-select-sm" id="agent-capability-select" style="width: 150px; display: none;">
                            <option value="">é€‰æ‹©èƒ½åŠ›...</option>
                            <option value="code_review">ä»£ç è¯„å®¡</option>
                            <option value="prd_review">PRDåˆ†æ</option>
                            <option value="test_case">æµ‹è¯•ç”Ÿæˆ</option>
                        </select>
                        
                        <select class="form-select form-select-sm" id="repository-select" style="width: 200px;">
                            <option value="">é€‰æ‹©å…³è”ä»“åº“...</option>
                        </select>
                        <select class="form-select form-select-sm" id="knowledge-base-select" style="width: 200px;">
                            <option value="">é€‰æ‹©çŸ¥è¯†åº“...</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadSessions()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div id="chat-messages" style="height: 400px; overflow-y: auto; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                    <div class="text-center text-muted" id="welcome-message">
                        <p>é€‰æ‹©ä¸€ä¸ªä¼šè¯æˆ–åˆ›å»ºæ–°ä¼šè¯å¼€å§‹å¯¹è¯</p>
                    </div>
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div id="input-area" style="display: none;">
                    <div class="input-group">
                        <textarea class="form-control" id="message-input" rows="3" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="bi bi-send"></i> å‘é€
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> AIå°†åŸºäºçŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£è¿›è¡Œå›ç­”
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ£€ç´¢åˆ°çš„æ–‡æ¡£ -->
        <div class="card mt-3" id="retrieved-docs-card" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> å‚è€ƒæ–‡æ¡£</h6>
            </div>
            <div class="card-body">
                <div id="retrieved-docs"></div>
            </div>
        </div>
    </div>
</div>

<style>
.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 80%;
}
.message.user {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}
.message.assistant {
    background-color: #e9ecef;
    color: #333;
}
.message.system {
    background-color: #ffc107;
    color: #333;
    text-align: center;
    max-width: 100%;
}
.session-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #dee2e6;
    transition: background-color 0.2s;
}
.session-item:hover {
    background-color: #f8f9fa;
}
.session-item.active {
    background-color: #e7f3ff;
    border-left: 3px solid #007bff;
}
.session-title {
    font-weight: 500;
    margin-bottom: 5px;
}
.session-time {
    font-size: 12px;
    color: #6c757d;
}
.typing-indicator {
    display: inline-block;
    animation: blink 1.4s infinite both;
}
.typing-indicator::before {
    content: 'AIæ­£åœ¨æ€è€ƒ';
}
@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
</style>

<script>
let currentMode = 'chat'; // 'chat' or 'agent'

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadRepositories();
    loadKnowledgeBases(); // åŠ è½½çŸ¥è¯†åº“
    loadSessions();
    
    // åˆå§‹åŒ–æ¨¡å¼
    toggleMode(false); // ä¸è§¦å‘åˆ‡æ¢äº‹ä»¶ï¼Œåªåˆå§‹åŒ–UI
    
    // ç»‘å®šå›è½¦å‘é€
    document.getElementById('message-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
});

// åˆ‡æ¢æ¨¡å¼
function toggleMode(isSwitch = true) {
    const modeSwitch = document.getElementById('mode-switch');
    const modeLabel = document.getElementById('mode-label');
    const welcomeMsg = document.getElementById('welcome-message');
    
    if (isSwitch) {
        currentMode = modeSwitch.checked ? 'agent' : 'chat';
    } else {
        // åˆå§‹åŒ–æ—¶æ ¹æ® checkbox çŠ¶æ€è®¾ç½®
        modeSwitch.checked = currentMode === 'agent';
    }
    
    if (currentMode === 'agent') {
        modeLabel.textContent = 'Agentæ¨¡å¼';
        modeLabel.classList.add('text-primary');
        document.getElementById('agent-capability-select').style.display = 'block';
        document.getElementById('knowledge-base-select').style.display = 'none';
        
        updateAgentWelcome();
    } else {
        modeLabel.textContent = 'Chatæ¨¡å¼';
        modeLabel.classList.remove('text-primary');
        document.getElementById('agent-capability-select').style.display = 'none';
        document.getElementById('knowledge-base-select').style.display = 'block';
        
        if (welcomeMsg) {
            welcomeMsg.innerHTML = `
                <h5>ğŸ’¬ Chat çŸ¥è¯†é—®ç­”æ¨¡å¼</h5>
                <p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥ä¸æˆ‘è¿›è¡Œè‡ªç”±å¯¹è¯ï¼š</p>
                <ul class="text-start d-inline-block">
                    <li>æŸ¥è¯¢å…³è”çŸ¥è¯†åº“å†…å®¹</li>
                    <li>åˆ†æä»£ç é€»è¾‘ä¸ä¸šåŠ¡è§„åˆ™</li>
                    <li>æŠ€æœ¯å’¨è¯¢ä¸æ–¹æ¡ˆæ¢è®¨</li>
                </ul>
            `;
        }
    }
}

// ç›‘å¬èƒ½åŠ›é€‰æ‹©å˜åŒ–
document.getElementById('agent-capability-select').addEventListener('change', updateAgentWelcome);

function updateAgentWelcome() {
    const capability = document.getElementById('agent-capability-select').value;
    const welcomeMsg = document.getElementById('welcome-message');
    if (!welcomeMsg) return;
    
    let content = '';
    switch(capability) {
        case 'code_review':
            content = `
                <h5>ğŸ§ ä»£ç è¯„å®¡ Agent</h5>
                <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                <ul class="text-start d-inline-block">
                    <li>å®¡æŸ¥ä»£ç é€»è¾‘ä¸è§„èŒƒ</li>
                    <li>å‘ç°æ½œåœ¨Bugä¸å®‰å…¨æ¼æ´</li>
                    <li>æä¾›é‡æ„å»ºè®®</li>
                </ul>
                <p class="text-muted small">è¯·é€‰æ‹©å…³è”ä»“åº“åå¼€å§‹å¯¹è¯</p>
            `;
            break;
        case 'prd_review':
            content = `
                <h5>ğŸ“ PRDåˆ†æ Agent</h5>
                <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                <ul class="text-start d-inline-block">
                    <li>è¯„å®¡éœ€æ±‚å®Œæ•´æ€§</li>
                    <li>åˆ†æä¸šåŠ¡é€»è¾‘æ¼æ´</li>
                    <li>ç”Ÿæˆç”¨ä¾‹è‰ç¨¿</li>
                </ul>
            `;
            break;
        case 'test_case':
            content = `
                <h5>ğŸ§ª æµ‹è¯•ç”Ÿæˆ Agent</h5>
                <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                <ul class="text-start d-inline-block">
                    <li>æ ¹æ®éœ€æ±‚ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</li>
                    <li>æ ¹æ®ä»£ç ç”Ÿæˆå•å…ƒæµ‹è¯•</li>
                    <li>è¦†ç›–è¾¹ç•Œæ¡ä»¶</li>
                </ul>
            `;
            break;
        default:
            content = `
                <h5>ğŸ¤– Agent æ™ºèƒ½å·¥ä½œæ¨¡å¼</h5>
                <p>è¯·åœ¨ä¸Šæ–¹é€‰æ‹©å…·ä½“èƒ½åŠ›ï¼ˆä»£ç è¯„å®¡ã€PRDåˆ†æã€æµ‹è¯•ç”Ÿæˆï¼‰</p>
            `;
    }
    welcomeMsg.innerHTML = content;
}

// åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
function loadKnowledgeBases() {
    // å‡è®¾æœ‰ä¸€ä¸ªçŸ¥è¯†åº“åˆ—è¡¨APIï¼Œè¿™é‡Œå…ˆç”¨ Mock æ•°æ®æˆ–å¤ç”¨ Repository API å¦‚æœçŸ¥è¯†åº“æ˜¯åŸºäºä»“åº“çš„
    // æˆ–è€…å¦‚æœè¿˜æ²¡æœ‰çŸ¥è¯†åº“ APIï¼Œå¯ä»¥å…ˆç½®ç©º
    const select = document.getElementById('knowledge-base-select');
    select.innerHTML = '<option value="">é€‰æ‹©çŸ¥è¯†åº“...</option>';
    
    // TODO: å®ç°åç«¯çŸ¥è¯†åº“åˆ—è¡¨ API
    // fetch('/api/v1/knowledge/bases/') ...
    // æš‚æ—¶æ·»åŠ ä¸€äº›ç¤ºä¾‹é€‰é¡¹
    const demoOptions = [
        {id: 'kb1', name: 'äº§å“éœ€æ±‚æ–‡æ¡£åº“'},
        {id: 'kb2', name: 'æŠ€æœ¯è§„èŒƒåº“'},
        {id: 'kb3', name: 'ä¸šåŠ¡è§„åˆ™åº“'}
    ];
    
    demoOptions.forEach(kb => {
        const option = document.createElement('option');
        option.value = kb.id;
        option.textContent = kb.name;
        select.appendChild(option);
    });
}

// åŠ è½½ä»“åº“åˆ—è¡¨
function loadRepositories() {
    fetch('/api/v1/repository/repositories/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        // DRFåˆ†é¡µæ ¼å¼: {count, next, previous, results}
        const repositories = result.results || result.data || [];
        const select = document.getElementById('repository-select');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©ä»“åº“</option>';
        
        repositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo.id;
            option.textContent = repo.name;
            select.appendChild(option);
        });
    })
    .catch(error => {
        console.error('åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥:', error);
    });
}

// åŠ è½½ä¼šè¯åˆ—è¡¨
function loadSessions() {
    fetch('/api/v1/knowledge/sessions/', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(result => {
        // DRFåˆ†é¡µæ ¼å¼: {count, next, previous, results} æˆ–è‡ªå®šä¹‰æ ¼å¼ {code, data}
        const sessions = result.results || result.data || [];
        const sessionList = document.getElementById('session-list');
        sessionList.innerHTML = '';
        
        if (sessions.length === 0) {
            sessionList.innerHTML = '<div class="p-3 text-center text-muted">æš‚æ— ä¼šè¯</div>';
            return;
        }
        
        // æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åˆ—
        sessions.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
        
        sessions.forEach(session => {
            const item = document.createElement('div');
            item.className = 'session-item';
            if (session.session_id === currentSessionId) {
                item.classList.add('active');
            }
            item.innerHTML = `
                <div class="session-title">${session.title}</div>
                <div class="session-time">${new Date(session.updated_at).toLocaleString()}</div>
            `;
            item.onclick = () => selectSession(session);
            sessionList.appendChild(item);
        });
    })
    .catch(error => {
        console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
    });
}

// åˆ›å»ºæ–°ä¼šè¯
function createNewSession() {
    const repositoryId = document.getElementById('repository-select').value;
    const title = prompt('è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜ï¼š', 'æ–°ä¼šè¯');
    
    if (!title) return;
    
    fetch('/api/v1/knowledge/sessions/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            title: title,
            repository_id: repositoryId || null
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.code === 0) {
            selectSession(result.data);
            loadSessions();
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + result.message);
        }
    });
}

// é€‰æ‹©ä¼šè¯
function selectSession(session) {
    currentSessionId = session.session_id;
    currentRepositoryId = session.repository_id;
    
    // æ›´æ–°UI
    document.getElementById('current-session-title').textContent = session.title;
    document.getElementById('input-area').style.display = 'block';
    
    // æ›´æ–°ä¼šè¯åˆ—è¡¨é«˜äº®
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
        if (item.querySelector('.session-title').textContent === session.title) {
            item.classList.add('active');
        }
    });
    
    // åŠ è½½æ¶ˆæ¯
    loadMessages(session);
}

// åŠ è½½æ¶ˆæ¯
function loadMessages(session) {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = '';
    
    if (!session.messages || session.messages.length === 0) {
        chatMessages.innerHTML = '<div class="text-center text-muted"><p>å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</p></div>';
        return;
    }
    
    session.messages.forEach(msg => {
        appendMessage(msg.role, msg.content);
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function appendMessage(role, content, isStreaming = false) {
    const chatMessages = document.getElementById('chat-messages');
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…é™¤æç¤º
    if (chatMessages.querySelector('.text-center')) {
        chatMessages.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    if (isStreaming) {
        messageDiv.id = 'streaming-message';
        messageDiv.innerHTML = content;
    } else {
        messageDiv.innerHTML = content.replace(/\n/g, '<br>');
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return messageDiv;
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || !currentSessionId) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯å¹¶é€‰æ‹©ä¼šè¯');
        return;
    }
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    appendMessage('user', message);
    
    // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message assistant typing-indicator';
    typingDiv.id = 'typing-indicator';
    document.getElementById('chat-messages').appendChild(typingDiv);
    
    // å‘é€åˆ°æœåŠ¡å™¨ï¼ˆæµå¼ï¼‰
    const capability = currentMode === 'agent' ? document.getElementById('agent-capability-select').value : 'general';
    const repoId = document.getElementById('repository-select').value;
    const kbId = document.getElementById('knowledge-base-select').value;
    
    let url = `/ai-chat/api/chat/stream/?session_id=${currentSessionId}&message=${encodeURIComponent(message)}`;
    url += `&conversation_type=${currentMode === 'agent' ? capability : 'chat'}`;
    if (repoId) url += `&repository_id=${repoId}`;
    if (kbId) url += `&knowledge_base_id=${kbId}`;
    
    fetch(url, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let streamingMessageDiv = null;
        
        function readStream() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    // æµç»“æŸ
                    if (streamingMessageDiv) {
                        streamingMessageDiv.innerHTML = fullResponse.replace(/\n/g, '<br>');
                    }
                    
                    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                    loadSessions();
                    return;
                }
                
                // è§£ç æ•°æ®
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') {
                            continue;
                        }
                        
                        try {
                            const json = JSON.parse(data);
                            
                            if (json.content) {
                                // ç§»é™¤æ­£åœ¨è¾“å…¥æç¤º
                                const typingIndicator = document.getElementById('typing-indicator');
                                if (typingIndicator) {
                                    typingIndicator.remove();
                                }
                                
                                // åˆ›å»ºæˆ–æ›´æ–°æµå¼æ¶ˆæ¯
                                if (!streamingMessageDiv) {
                                    streamingMessageDiv = appendMessage('assistant', '', true);
                                }
                                
                                fullResponse += json.content;
                                streamingMessageDiv.innerHTML = fullResponse.replace(/\n/g, '<br>');
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing JSON:', e);
                        }
                    }
                }
                
                return readStream();
            });
        }
        
        return readStream();
    })
    .catch(error => {
        console.error('Stream error:', error);
        
        // ç§»é™¤æ­£åœ¨è¾“å…¥æç¤º
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        alert('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// è·å–CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}