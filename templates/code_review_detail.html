{% extends 'base.html' %}

{% block title %}评审详情 - 熵减X-AI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="/code-review/reviews/" class="text-decoration-none"><i class="bi bi-arrow-left"></i> 返回评审列表</a>
        <h2 class="mt-2">代码评审详情</h2>
    </div>
    <div>
        <span class="badge {% if review.risk_level == 'HIGH' %}risk-badge-HIGH{% elif review.risk_level == 'MEDIUM' %}risk-badge-MEDIUM{% else %}risk-badge-LOW{% endif %} fs-5">
            {{ review.get_risk_level_display }} ({{ review.risk_score|floatformat:0 }}%)
        </span>
    </div>
</div>

<!-- 基本信息 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">基本信息</h5>
    </div>
    <div class="card-body">
        <table class="table">
            <tr>
                <td style="width: 120px;"><strong>仓库</strong></td>
                <td>{{ review.repository.name }}</td>
                <td style="width: 120px;"><strong>分支</strong></td>
                <td><code>{{ review.branch }}</code></td>
            </tr>
            <tr>
                <td><strong>提交</strong></td>
                <td><code>{{ review.commit_hash }}</code></td>
                <td><strong>提交时间</strong></td>
                <td>{{ review.commit_time|date:"Y-m-d H:i:s" }}</td>
            </tr>
            <tr>
                <td><strong>作者</strong></td>
                <td>{{ review.author }} ({{ review.author_email }})</td>
                <td><strong>评审时间</strong></td>
                <td>{{ review.created_at|date:"Y-m-d H:i:s" }}</td>
            </tr>
            <tr>
                <td><strong>提交信息</strong></td>
                <td colspan="3"><pre>{{ review.commit_message }}</pre></td>
            </tr>
        </table>
    </div>
</div>

<!-- 变更文件 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">变更文件 ({{ review.changed_files|length }})</h5>
    </div>
    <div class="card-body">
        <div class="list-group list-group-flush">
            {% for f in review.changed_files %}
            <div class="list-group-item">
                <span class="badge {% if f.status == 'A' %}bg-success{% elif f.status == 'M' %}bg-primary{% elif f.status == 'D' %}bg-danger{% else %}bg-secondary{% endif %}">
                    {{ f.status }}
                </span>
                <span class="ms-2">{{ f.path }}</span>
                {% if f.is_critical %}
                <span class="badge bg-warning text-dark ms-2">关键文件</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- AI评审内容 -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">AI评审结果</h5>
    </div>
    <div class="card-body">
        <div class="alert {% if review.risk_level == 'HIGH' %}alert-danger{% elif review.risk_level == 'MEDIUM' %}alert-warning{% else %}alert-success{% endif %}">
            {{ review.ai_review_content|linebreaks }}
        </div>
    </div>
</div>

<!-- Diff内容 -->
{% if review.diff_content %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">代码变更 (Diff)</h5>
    </div>
    <div class="card-body">
        <pre style="max-height: 400px; overflow: auto;">{{ review.diff_content }}</pre>
    </div>
</div>
{% endif %}

<!-- 反馈操作 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">反馈</h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <span class="me-2">当前状态:</span>
            <span class="badge {% if review.feedback_status == 'PENDING' %}bg-warning{% elif review.feedback_status == 'CORRECT' %}bg-success{% elif review.feedback_status == 'FALSE_POSITIVE' %}bg-danger{% else %}bg-info{% endif %}">
                {{ review.get_feedback_status_display }}
            </span>
        </div>
        
        {% if review.feedback_status == 'PENDING' %}
        <div class="btn-group">
            <button class="btn btn-success" onclick="submitFeedback('CORRECT')">
                <i class="bi bi-check"></i> 评审准确
            </button>
            <button class="btn btn-warning" onclick="submitFeedback('FALSE_POSITIVE')">
                <i class="bi bi-x"></i> 误报
            </button>
            <button class="btn btn-info" onclick="submitFeedback('MISSED')">
                <i class="bi bi-exclamation"></i> 漏报
            </button>
        </div>
        {% endif %}
        
        {% if review.feedback_comment %}
        <div class="mt-3">
            <strong>反馈说明:</strong>
            <p class="mt-2">{{ review.feedback_comment }}</p>
            <small class="text-muted">
                反馈人: {{ review.feedback_by.username|default:"未知" }}
                时间: {{ review.feedback_at|default:"" }}
            </small>
        </div>
        {% endif %}
    </div>
</div>

<script>
const reviewId = {{ review.id }};

// 获取CSRF Token
function getCsrfToken() {
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1] || '';
}

function submitFeedback(status) {
    const comment = prompt('请输入反馈说明（可选）:');
    fetch(`/api/v1/code-review/reviews/${reviewId}/feedback/`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ feedback_status: status, comment: comment || '' })
    }).then(r => r.json()).then(data => {
        if (data.code === 0) {
            location.reload();
        } else {
            alert(data.message || '提交失败');
        }
    });
}
</script>
{% endblock %}
